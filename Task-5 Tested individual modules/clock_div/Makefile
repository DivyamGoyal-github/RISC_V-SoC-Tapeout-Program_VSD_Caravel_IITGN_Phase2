# ============================================================
# Makefile for clock_div RTL simulation (Synopsys VCS)
# ============================================================

# ------------------------------------------------------------
# Tools
# ------------------------------------------------------------
VCS      = vcs
GTKWAVE  = gtkwave

# ------------------------------------------------------------
# Files
# ------------------------------------------------------------
RTL      = clock_div.v
TB       = clock_div_tb.v
TOP      = tb_clock_div

# ------------------------------------------------------------
# Output files
# ------------------------------------------------------------
SIMV     = simv
VCD      = clock_div.vcd
LOG      = sim.log

# ------------------------------------------------------------
# VCS flags
# ------------------------------------------------------------
VCS_FLAGS = -full64 \
            -sverilog \
            -debug_access+all \
            -timescale=1ns/1ps \
            +define+CLK_DIV=3\'b010 \
            +vcs+lic+wait


# ------------------------------------------------------------
# Default target
# ------------------------------------------------------------
all: run

# ------------------------------------------------------------
# Compile
# ------------------------------------------------------------
compile:
	@echo "=============================="
	@echo " Compiling RTL + Testbench"
	@echo "=============================="
	$(VCS) $(VCS_FLAGS) \
		-top $(TOP) \
		$(RTL) $(TB) \
		-o $(SIMV)

# ------------------------------------------------------------
# Run simulation
# ------------------------------------------------------------
run: compile
	@echo "=============================="
	@echo " Running Simulation"
	@echo "=============================="
	./$(SIMV) | tee $(LOG)

	@echo ""
	@echo "=============================="
	@grep -q "TEST COMPLETED SUCCESSFULLY" $(LOG) && \
		echo " RESULT: ✅ TEST PASSED" || \
		echo " RESULT: ❌ TEST FAILED"
	@echo "=============================="

# ------------------------------------------------------------
# Run with VCD dump
# ------------------------------------------------------------
vcd: compile
	@echo "=============================="
	@echo " Running Simulation (VCD ON)"
	@echo "=============================="
	./$(SIMV) +dump_vcd | tee $(LOG)

# ------------------------------------------------------------
# Open waveform in GTKWave
# ------------------------------------------------------------
wave: vcd
	$(GTKWAVE) $(VCD) &

# ------------------------------------------------------------
# Clean
# ------------------------------------------------------------
clean:
	rm -rf $(SIMV)* csrc *.daidir *.key *.log *.vcd ucli.key DVEfiles

.PHONY: all compile run vcd wave clean

